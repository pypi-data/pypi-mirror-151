let wiz_controller = async ($sce, $scope, $timeout) => {
    let _$timeout = $timeout;
    $timeout = (timestamp) => new Promise((resolve) => _$timeout(resolve, timestamp));

    $scope.link = async (link) => {
        location.href = link;
    }

    let DEFAULT_QUERY = {
        page: 1,
        dump: 20,
        text: ''
    };

    $scope.workflow = {};
    $scope.workflow.list = [];
    $scope.workflow.loading = false;
    $scope.workflow.tab = 'private';

    $scope.workflow.lastpage = 0;
    $scope.workflow.query = angular.copy(DEFAULT_QUERY);

    $scope.workflow.pagination = async () => {
        let lastpage = $scope.workflow.lastpage * 1;
        let startpage = Math.floor(($scope.workflow.query.page - 1) / 10) * 10 + 1;
        $scope.workflow.pages = [];
        for (var i = 0; i < 10; i++) {
            if (startpage + i > lastpage) break;
            $scope.workflow.pages.push(startpage + i);
        }
        await $timeout();
    }

    $scope.workflow.load = {};
    $scope.workflow.load.current = async (init) => {
        if (init) {
            $scope.workflow.query.page = 1;
        }

        if ($scope.workflow.tab == 'private') {
            await $scope.workflow.load.private();
        } else {
            await $scope.workflow.load.hub();
        }
    }

    $scope.workflow.load.page = async (page) => {
        if (page < 1) {
            toastr.error('첫 페이지 입니다');
            return;
        }
        if (page > $scope.workflow.lastpage) {
            toastr.error('마지막 페이지 입니다');
            return;
        }

        if ($scope.workflow.query.page == page) {
            return;
        }

        $scope.workflow.query.page = page;
        await $scope.workflow.load.current();
    }

    $scope.workflow.load.private = async (init) => {
        if (init) {
            $scope.workflow.query = angular.copy(DEFAULT_QUERY);
        }

        let q = angular.copy($scope.workflow.query);
        let res = await wiz.API.async("myworkflow", q);
        $scope.workflow.list = res.data.result;
        
        $scope.workflow.lastpage = res.data.lastpage;
        $scope.workflow.tab = 'private';
        $scope.workflow.loading = true;

        await $scope.workflow.pagination();
        await $timeout();
    }

    $scope.workflow.load.hub = async (init) => {
        if (init) {
            $scope.workflow.query = angular.copy(DEFAULT_QUERY);
        }

        let q = angular.copy($scope.workflow.query);
        let res = await wiz.API.async("hubworkflow", q);
        $scope.workflow.list = res.data.result;
        $scope.workflow.lastpage = res.data.lastpage;
        $scope.workflow.tab = 'hub';
        $scope.workflow.loading = true;

        await $scope.workflow.pagination();
        await $timeout();
    }

    await $scope.workflow.load.private();
}
